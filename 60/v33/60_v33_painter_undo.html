<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>60! v33 — Pattern Painter (Undo/Redo)</title>
<style>

  :root{--bg:#0f1420;--tile-on:#3ec7c2;--tile-off:#2a3550;--ink:#e8eef8;--muted:#9fb3c8;--digit-ink:#e7f0ff;--ring:#ffd16688;}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial}
  h1{font-size:18px;margin:10px 0 8px}
  .wrap{display:flex;flex-direction:column;align-items:center}
  .hud{width:100%;max-width:980px;box-sizing:border-box;padding:0 8px;color:var(--muted);font-size:14px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  canvas{display:block}
  .bar{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin:10px 0 14px}
  button{padding:10px 14px;border:0;border-radius:12px;background:#2a3550;color:var(--digit-ink);font-weight:700}
  button.btn-on{background:var(--tile-on);color:#0a1320}
  input[type=text],input[type=url]{background:#151d30;color:var(--ink);border:1px solid #2b3b61;border-radius:10px;padding:8px 10px;min-width:260px}
  .note{color:var(--muted);font-size:12px}
  .card{background:#141c2d;border:1px solid #23314e;border-radius:14px;padding:12px;margin:8px 0;max-width:980px}

</style>
</head>
<body>
<div class="wrap">
  <h1>60! v33 — Pattern Painter (Undo/Redo)</h1>
  <div class="hud">
    <div class="card">
      <div class="row">
        <button id="undo">Visszavonás (Ctrl+Z)</button>
        <button id="redo">Újra (Ctrl+Y)</button>
        <button id="save">Mentés (localStorage)</button>
        <button id="load">Betöltés</button>
        <span class="note">Rajzolj húzással; azonos cellán nem dupláz.</span>
      </div>
    </div>
  </div>
  <canvas id="stage" aria-label="6×10 painter grid"></canvas>
  <div class="bar">
    <button id="n1">N1</button><button id="n2">N2</button><button id="n3">N3</button><button id="n4">N4</button>
    <button id="clear">Clear</button>
  </div>
</div>
<script>
(()=>{
  const COLS=6, ROWS=10, DPR=Math.max(1,Math.min(window.devicePixelRatio||1,2));
  const canvas=document.getElementById('stage'); const ctx=canvas.getContext('2d');
  const css=v=>getComputedStyle(document.documentElement).getPropertyValue(v).trim();
  const COLORS={BG:css('--bg'),ON:css('--tile-on'),OFF:css('--tile-off'),INK:css('--ink'),DIG:css('--digit-ink')};
  const grid={cols:COLS,rows:ROWS,size:0,pad:10,radius:12};
  const STORAGE_KEY=`v33_en_binmask_${COLS}x${ROWS}_combo16`;
  function empty(){return Array.from({length:grid.rows},()=>Array(grid.cols).fill(false));}
  let boards=Array.from({length:16},()=>({matrix:empty(),onCount:0,boards:'0'})); let active=[false,false,false,false]; let view=0;
  function mask(){return (active[0]?1:0)|(active[1]?2:0)|(active[2]?4:0)|(active[3]?8:0);}
  const btns=[...['n1','n2','n3','n4'].map(id=>document.getElementById(id))];
  btns.forEach((b,i)=>b.onclick=()=>{active[i]=!active[i]; view=mask(); renderBtns(); draw();});
  function renderBtns(){btns.forEach((b,i)=>b.classList.toggle('btn-on',!!active[i]));}
  function fit(){
    const maxW=Math.max(320, window.innerWidth-36); const maxH=Math.max(260, window.innerHeight-220);
    grid.pad=Math.round(Math.max(8,Math.min(16,Math.min(maxW,maxH)*0.025)));
    const sW=Math.floor((maxW-(grid.pad*(grid.cols+1)))/grid.cols), sH=Math.floor((maxH-(grid.pad*(grid.rows+1)))/grid.rows);
    const MAX_TILE=Math.min(128, Math.floor(window.innerWidth/4.6));
    grid.size=Math.min(MAX_TILE, Math.max(48, Math.min(sW,sH)));
    const cssW=grid.cols*(grid.size+grid.pad)+grid.pad, cssH=grid.rows*(grid.size+grid.pad)+grid.pad;
    canvas.style.width=cssW+'px'; canvas.style.height=cssH+'px'; canvas.width=Math.round(cssW*DPR); canvas.height=Math.round(cssH*DPR);
    ctx.setTransform(DPR,0,0,DPR,0,0); draw();
  }
  function rr(x,y,w,h,r){const a=Math.min(r,w/2,h/2);ctx.beginPath();ctx.moveTo(x+a,y);ctx.arcTo(x+w,y,x+w,y+h,a);ctx.arcTo(x+w,y+h,x,y+h,a);ctx.arcTo(x,y+h,x,y,a);ctx.arcTo(x,y,x+w,y,a);ctx.closePath();}
  function drawHex(cx,cy,txt,on){ctx.textAlign='center';ctx.textBaseline='middle';ctx.font='700 '+Math.max(16,Math.floor(grid.size*0.42))+'px Inter,system-ui';ctx.fillStyle=on?'#0a1320':COLORS.DIG;ctx.fillText(txt,cx,cy);}
  function draw(){const b=boards[view]; ctx.fillStyle=COLORS.BG; ctx.fillRect(0,0,canvas.width/DPR,canvas.height/DPR);
    for(let r=0;r<grid.rows;r++) for(let c=0;c<grid.cols;c++){const idx=r*grid.cols+c, hex=idx.toString(16).toUpperCase().padStart(2,'0'); const x=c*(grid.size+grid.pad)+grid.pad, y=r*(grid.size+grid.pad)+grid.pad;
      rr(x,y,grid.size,grid.size,grid.radius); const on=b.matrix[r][c]; ctx.fillStyle=on?COLORS.ON:COLORS.OFF; ctx.fill(); drawHex(x+grid.size/2,y+grid.size/2,hex,on); }
  }
  function clone(m){return m.map(row=>row.slice());}
  const undoStack=[]; const redoStack=[]; let painting=false; let paintValue=true; const touched=new Set();
  function key(r,c){return r+','+c;}
  function pushUndo(){undoStack.push(clone(boards[view].matrix)); if(undoStack.length>100) undoStack.shift(); redoStack.length=0;}
  function applyMatrix(m){boards[view].matrix = clone(m); draw();}
  function setCell(r,c,val){const b=boards[view]; if(b.matrix[r][c]===val) return; b.matrix[r][c]=val;}
  canvas.addEventListener('mousedown',e=>{painting=true; touched.clear(); pushUndo(); handlePaint(e);});
  canvas.addEventListener('mousemove',e=>{if(painting) handlePaint(e);});
  window.addEventListener('mouseup',()=>{painting=false; touched.clear(); draw();});
  function handlePaint(e){const rect=canvas.getBoundingClientRect(); const x=e.clientX-rect.left, y=e.clientY-rect.top;
    for(let r=0;r<grid.rows;r++) for(let c=0;c<grid.cols;c++){const cx=c*(grid.size+grid.pad)+grid.pad, cy=r*(grid.size+grid.pad)+grid.pad;
      if(x>=cx&&x<=cx+grid.size&&y>=cy&&y<=cy+grid.size){const k=key(r,c); if(!touched.has(k)){touched.add(k); const cur=boards[view].matrix[r][c]; if(touched.size===1) paintValue=!cur; setCell(r,c,paintValue); } }
  } draw();}
  document.getElementById('undo').onclick=()=>{if(!undoStack.length) return; const m=undoStack.pop(); redoStack.push(clone(boards[view].matrix)); applyMatrix(m);};
  document.getElementById('redo').onclick=()=>{if(!redoStack.length) return; const m=redoStack.pop(); undoStack.push(clone(boards[view].matrix)); applyMatrix(m);};
  document.addEventListener('keydown',e=>{if(e.ctrlKey&&e.key.toLowerCase()==='z'){e.preventDefault();document.getElementById('undo').click();} if(e.ctrlKey&&e.key.toLowerCase()==='y'){e.preventDefault();document.getElementById('redo').click();} });
  document.getElementById('save').onclick=()=>{try{const s=localStorage.getItem(STORAGE_KEY); const base=s?JSON.parse(s):{}; base.boardsState=boards; base.activeButtons=active; base.viewIndex=view; localStorage.setItem(STORAGE_KEY,JSON.stringify(base)); alert('Mentve ✓');}catch(err){alert('Mentés hiba');}};
  document.getElementById('load').onclick=()=>{try{const s=localStorage.getItem(STORAGE_KEY); if(!s) return alert('Nincs mentett állapot'); const st=JSON.parse(s); boards=st.boardsState||boards; active=st.activeButtons||active; view=(typeof st.viewIndex==='number')?st.viewIndex:view; renderBtns(); draw();}catch(err){alert('Betöltés hiba');}};
  document.getElementById('clear').onclick=()=>{boards=Array.from({length:16},()=>({matrix:empty(),onCount:0,boards:'0'})); draw();};
  window.addEventListener('resize',fit); fit(); renderBtns(); draw();
})();
</script>
</body>
</html>
